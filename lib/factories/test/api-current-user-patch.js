// Generated by CoffeeScript 1.9.3
module.exports.testApiCurrentUserPatchForbidden = function(command_serve, pgDropCreateMigrate, shutdown, envStringBaseUrl, urlApiLogin, urlApiCurrentUser, requestPromise, insertUser) {
  return function(test) {
    return pgDropCreateMigrate().then(function() {
      return insertUser({
        email: 'test@example.com',
        name: 'exampleuser',
        password: 'topsecret',
        rights: ''
      });
    }).then(function() {
      return command_serve('cockpit');
    }).then(function() {
      return requestPromise({
        method: 'POST',
        url: envStringBaseUrl + urlApiLogin(),
        json: true,
        body: {
          username: 'exampleuser',
          password: 'topsecret'
        }
      });
    }).then(function(arg) {
      var response, token;
      response = arg[0];
      test.equal(response.statusCode, 200);
      token = response.body.token;
      return requestPromise({
        method: 'PATCH',
        url: envStringBaseUrl + urlApiCurrentUser(),
        headers: {
          authorization: "Bearer " + token
        },
        json: true
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 403);
      return shutdown();
    }).then(function() {
      return test.done();
    });
  };
};

module.exports.testApiCurrentUserPatchUnprocessable = function(command_serve, pgDropCreateMigrate, shutdown, envStringBaseUrl, urlApiLogin, urlApiCurrentUser, requestPromise, insertUser) {
  return function(test) {
    return pgDropCreateMigrate().then(function() {
      return insertUser({
        email: 'test@example.com',
        name: 'exampleuser',
        password: 'topsecret',
        rights: 'canAccessCockpit'
      });
    }).then(function() {
      return command_serve('cockpit');
    }).then(function() {
      return requestPromise({
        method: 'POST',
        url: envStringBaseUrl + urlApiLogin(),
        json: true,
        body: {
          username: 'exampleuser',
          password: 'topsecret'
        }
      });
    }).then(function(arg) {
      var response, token;
      response = arg[0];
      test.equal(response.statusCode, 200);
      token = response.body.token;
      return requestPromise({
        method: 'PATCH',
        url: envStringBaseUrl + urlApiCurrentUser(),
        body: {
          email: 'dkjdlkf',
          name: '',
          password: '',
          rights: 'canAccessAllAndEverything # trying to escalate own rights should fail'
        },
        headers: {
          authorization: "Bearer " + token
        },
        json: true
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 422);
      test.deepEqual(response.body, {
        name: 'must not be the empty string',
        password: 'must not be the empty string',
        email: 'must be an email address',
        rights: 'you are not allowed to set your own rights'
      });
      return shutdown();
    }).then(function() {
      return test.done();
    });
  };
};

module.exports.testApiCurrentUserPatchUnprocessableTaken = function(command_serve, pgDropCreateMigrate, shutdown, envStringBaseUrl, urlApiLogin, urlApiCurrentUser, requestPromise, insertUser) {
  return function(test) {
    return pgDropCreateMigrate().bind({}).then(function() {
      return insertUser({
        email: 'test@example.com',
        name: 'exampleuser',
        password: 'topsecret',
        rights: 'canAccessCockpit'
      });
    }).then(function() {
      return insertUser({
        email: 'othertest@example.com',
        name: 'otherexampleuser',
        password: 'topsecret',
        rights: 'canAccessCockpit'
      });
    }).then(function() {
      return command_serve('cockpit');
    }).then(function() {
      return requestPromise({
        method: 'POST',
        url: envStringBaseUrl + urlApiLogin(),
        json: true,
        body: {
          username: 'exampleuser',
          password: 'topsecret'
        }
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 200);
      this.token = response.body.token;
      return requestPromise({
        method: 'PATCH',
        url: envStringBaseUrl + urlApiCurrentUser(),
        body: {
          email: 'othertest@example.com',
          name: 'otherexampleuser',
          password: 'topsecret'
        },
        headers: {
          authorization: "Bearer " + this.token
        },
        json: true
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 422);
      test.deepEqual(response.body, {
        name: 'taken',
        email: 'taken'
      });
      return requestPromise({
        method: 'PATCH',
        url: envStringBaseUrl + urlApiCurrentUser(),
        body: {
          email: 'othertest@example.com',
          name: 'exampleuser',
          password: 'topsecret'
        },
        headers: {
          authorization: "Bearer " + this.token
        },
        json: true
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 422);
      test.deepEqual(response.body, {
        email: 'taken'
      });
      return requestPromise({
        method: 'PATCH',
        url: envStringBaseUrl + urlApiCurrentUser(),
        body: {
          email: 'test@example.com',
          name: 'otherexampleuser',
          password: 'topsecret'
        },
        headers: {
          authorization: "Bearer " + this.token
        },
        json: true
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 422);
      test.deepEqual(response.body, {
        name: 'taken'
      });
      return shutdown();
    }).then(function() {
      return test.done();
    });
  };
};

module.exports.testApiCurrentUserPatchOkNoChange = function(command_serve, pgDropCreateMigrate, shutdown, envStringBaseUrl, urlApiLogin, urlApiCurrentUser, requestPromise, insertUser) {
  return function(test) {
    return pgDropCreateMigrate().then(function() {
      return insertUser({
        email: 'test@example.com',
        name: 'exampleuser',
        password: 'topsecret',
        rights: 'canAccessCockpit'
      });
    }).then(function() {
      return command_serve('cockpit');
    }).then(function() {
      return requestPromise({
        method: 'POST',
        url: envStringBaseUrl + urlApiLogin(),
        json: true,
        body: {
          username: 'exampleuser',
          password: 'topsecret'
        }
      });
    }).then(function(arg) {
      var response, token;
      response = arg[0];
      test.equal(response.statusCode, 200);
      token = response.body.token;
      return requestPromise({
        method: 'PATCH',
        url: envStringBaseUrl + urlApiCurrentUser(),
        body: {
          email: 'test@example.com',
          name: 'exampleuser',
          password: 'topsecret'
        },
        headers: {
          authorization: "Bearer " + token
        },
        json: true
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 200);
      test.equal(response.body.email, 'test@example.com');
      test.equal(response.body.name, 'exampleuser');
      test.equal(response.body.rights, 'canAccessCockpit');
      return shutdown();
    }).then(function() {
      return test.done();
    });
  };
};

module.exports.testApiCurrentUserPatchOkChange = function(command_serve, pgDropCreateMigrate, shutdown, envStringBaseUrl, urlApiLogin, urlApiCurrentUser, requestPromise, insertUser) {
  return function(test) {
    return pgDropCreateMigrate().then(function() {
      return insertUser({
        email: 'test@example.com',
        name: 'exampleuser',
        password: 'topsecret',
        rights: 'canAccessCockpit'
      });
    }).then(function() {
      return command_serve('cockpit');
    }).then(function() {
      return requestPromise({
        method: 'POST',
        url: envStringBaseUrl + urlApiLogin(),
        json: true,
        body: {
          username: 'exampleuser',
          password: 'topsecret'
        }
      });
    }).then(function(arg) {
      var response, token;
      response = arg[0];
      test.equal(response.statusCode, 200);
      token = response.body.token;
      return requestPromise({
        method: 'PATCH',
        url: envStringBaseUrl + urlApiCurrentUser(),
        body: {
          email: 'changedtest@example.com',
          name: 'changedexampleuser',
          password: 'changedtopsecret'
        },
        headers: {
          authorization: "Bearer " + token
        },
        json: true
      });
    }).then(function(arg) {
      var response;
      response = arg[0];
      test.equal(response.statusCode, 200);
      test.equal(response.body.email, 'changedtest@example.com');
      test.equal(response.body.name, 'changedexampleuser');
      test.equal(response.body.rights, 'canAccessCockpit');
      return shutdown();
    }).then(function() {
      return test.done();
    });
  };
};
